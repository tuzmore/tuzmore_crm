{% extends 'base.html' %}
{% block title %}Contacts{% endblock %}
{% block content %}

<section class="min-h-screen bg-gray-100 py-10 px-6">
  <div class="max-w-3xl mx-auto">
    <!-- Page Title -->
    <h1 class="text-3xl font-bold text-gray-800 mb-8">üë§ Contacts</h1>

    <!-- Add Contact Form -->
    <div class="bg-white shadow rounded-2xl p-6 mb-10">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">‚ûï Add New Contact</h2>
      <form id="contactForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- First Name -->
        <div class="flex flex-col">
          <label for="first_name" class="text-sm text-gray-600 mb-1">First Name</label>
          <input type="text" id="first_name" class="border rounded-lg px-3 py-2 focus:ring focus:ring-blue-300" placeholder="John" required>
        </div>

        <!-- Last Name -->
        <div class="flex flex-col">
          <label for="last_name" class="text-sm text-gray-600 mb-1">Last Name</label>
          <input type="text" id="last_name" class="border rounded-lg px-3 py-2 focus:ring focus:ring-blue-300" placeholder="Doe" required>
        </div>

        <!-- Email -->
        <div class="flex flex-col">
          <label for="email" class="text-sm text-gray-600 mb-1">Email</label>
          <input type="email" id="email" class="border rounded-lg px-3 py-2 focus:ring focus:ring-blue-300" placeholder="johndoe@email.com" required>
        </div>

        <!-- Phone -->
        <div class="flex flex-col">
          <label for="phone" class="text-sm text-gray-600 mb-1">Phone</label>
          <input type="text" id="phone" class="border rounded-lg px-3 py-2 focus:ring focus:ring-blue-300" placeholder="+1234567890">
        </div>

        <!-- Submit -->
        <div class="md:col-span-4 flex justify-end">
          <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg shadow hover:bg-blue-700">‚ûï Add Contact</button>
        </div>
      </form>
    </div>

    <!-- Contacts Table -->
    <div class="bg-white shadow rounded-2xl p-6">
      <h2 class="text-xl font-semibold mb-4 text-gray-700">All Contacts</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-sm text-gray-600">ID</th>
              <th class="px-4 py-2 text-sm text-gray-600">First Name</th>
              <th class="px-4 py-2 text-sm text-gray-600">Last Name</th>
              <th class="px-4 py-2 text-sm text-gray-600">Email</th>
              <th class="px-4 py-2 text-sm text-gray-600">Phone</th>
              <th class="px-4 py-2 text-sm text-gray-600">Owner</th>
              <th class="px-4 py-2 text-sm text-gray-600">Created At</th>
            </tr>
          </thead>
          <tbody id="contactsTable" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<script>
  const API_URL = "/api/contacts/";
  const token = localStorage.getItem("access"); // Save JWT token here after login

  // Fetch all contacts
  async function fetchContacts() {
    if (!token) {
      alert("‚ö†Ô∏è Please log in first.");
      return;
    }

    try {
      const res = await fetch(API_URL, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.ok) throw new Error("Failed to fetch contacts");

      const contacts = await res.json();
      const table = document.getElementById("contactsTable");
      table.innerHTML = "";

      contacts.forEach((contact) => {
        table.innerHTML += `
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-2">${contact.id}</td>
            <td class="px-4 py-2 font-medium text-gray-800">${contact.first_name}</td>
            <td class="px-4 py-2">${contact.last_name}</td>
            <td class="px-4 py-2 text-blue-600">${contact.email}</td>
            <td class="px-4 py-2 text-gray-700">${contact.phone || "-"}</td>
            <td class="px-4 py-2 text-gray-600">${contact.owner}</td>
            <td class="px-4 py-2 text-gray-500">${new Date(contact.created_at).toLocaleString()}</td>
          </tr>
        `;
      });
    } catch (err) {
      console.error("‚ùå Error fetching contacts:", err);
    }
  }

  // Add new contact
  document.getElementById("contactForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const first_name = document.getElementById("first_name").value;
    const last_name = document.getElementById("last_name").value;
    const email = document.getElementById("email").value;
    const phone = document.getElementById("phone").value;

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ first_name, last_name, email, phone })
      });

      if (!res.ok) {
        const errorData = await res.json();
        alert("‚ùå Failed: " + JSON.stringify(errorData));
        return;
      }

      document.getElementById("contactForm").reset();
      fetchContacts();
    } catch (err) {
      console.error("‚ùå Error adding contact:", err);
    }
  });

  // Load contacts on page load
  fetchContacts();
</script>

{% endblock %}
